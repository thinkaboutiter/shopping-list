FROM boyankov/swift:swift-4.2-ubuntu-16.04
LABEL Description="Shopping list, a sample app in swift."

# Get extra dependencies for Perfect
RUN apt-get update && apt-get install -y \
openssl \
libssl-dev \
uuid-dev \
libmongoc-dev \
libbson-dev \
iputils-ping \
tree \
mc

# Expose default port for App Engine
EXPOSE 8080

# Copy sources
WORKDIR /opt/ShoppingList/Sources
COPY Sources/ .

WORKDIR /opt/ShoppingList
COPY Package.swift .

# Attach stdout to log file
# script attemt
# COPY create-logs-directory.sh .
# RUN chmod +x ./create-logs-directory.sh \
# && bash -c "./create-logs-directory.sh" \
# && ln -sf /dev/stdout /opt/ShoppingList/Sources/ShoppingList/logs/application.log

# inline attemt 
# RUN #!/bin/bash \
# LOGS_DIR="/opt/ShoppingList/Sources/ShoppingList/logs" \
# if [ ! -d ${LOGS_DIR} ]; then \
# mkdir ${LOGS_DIR} \
# fi \
# FILE_NAME="application.log" \
# if [ ! -f "${LOGS_DIR}/${FILE_NAME}" ]; then \
# touch "${LOGS_DIR}/${FILE_NAME}" \
# fi \
# && ln -sf /dev/stdout /opt/ShoppingList/Sources/ShoppingList/logs/application.log

# Release build
# RUN swift build -c release -Xswiftc -static-stdlib
RUN swift build

# Run the app
USER root
CMD ["swift", "run"]
